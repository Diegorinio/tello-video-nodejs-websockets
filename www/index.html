<!DOCTYPE html>
<html>
<head>
	<title>Tello drone control</title>
	<link rel='stylesheet' href='./main.css'>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
</head>
<body>
	<canvas height="500" width="500" id="video-canvas"></canvas>
	<script type="text/javascript" src="jsmpeg.min.js"></script>
	<script type="text/javascript">
		var gamepad
		var ws = new WebSocket('ws://localhost:8000/')
		var canvas = document.getElementById('video-canvas');
		var url = 'ws://'+document.location.hostname+':3001/stream';
		console.log(url)
		var player = new JSMpeg.Player(url, {canvas: canvas});
		var gl = canvas.getContext("webgl")
		window.addEventListener("gamepadconnected", function(e){
			gamepad = e.gamepad
			//0=A 1=B 2=home 3=plus 4=minus 5=1 6=2
			console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.", gamepad.index,gamepad.id, gamepad.buttons.length, gamepad.axes.length)
			setInterval(()=>{
				if(gamepad.buttons[0].value == 1)
				{
					console.log("wiiremote up")
				}
				if(gamepad.buttons[1].value == 1)
				{
					console.log("wiiremote down")
				}
				if(gamepad.buttons[2].value == 1)
				{
					console.log("wiiremote takeoff")
				}
				if(gamepad.buttons[3].value == 1)
				{
					console.log("wiiremote right")
				}
				if(gamepad.buttons[4].value == 1)
				{
					console.log("wiiremote left")
				}
				if(gamepad.buttons[5].value == 1)
				{
					console.log("wiiremote 1 button")
				}
				if(gamepad.buttons[6].value == 1)
				{
					console.log("wiiremote land")
				}
			}, 100)
		})

		// // if(gamepad)
		// // {	
		// 	console.log("gamepad interval")
		// 	setInterval(()=>{
		// 		for(x= 0; x<=gamepad.buttons.length; x++)
		// 		{
		// 			console.log(gamepad.buttons[x].value)
		// 		}
		// 	}, 1000)
		// // }

		window.addEventListener('keydown', (event)=>{
				// switch(event.keyCode)
				// {
				// 	case 39:
				// 		console.log("right")
				// 		ws.send("rotate-right")
				// 		break;
				// 	case 37:
				// 		console.log("left")
				// 		ws.send("rotate-left")
				// 		break
				// 	case 80:
				// 		ws.send("takeoff")
				// 		console.log("takeoff")
				// 		break;
				// 	case 16:
				// 		ws.send("land")
				// 		break;
				// 	case 87:
				// 		ws.send("forward")
				// 	case 83:
				// 		ws.send("backward")
				// 		break
				// 	case 65:
				// 		ws.send("left")
				// 		console.log("left")
				// 		break
				// 	case 68:
				// 		ws.send("right")
				// 		console.log("right")
				// 		break
				// 	case 38:
				// 		ws.send("up")
				// 		console.log('up')
				// 		break
				// 	case 40:
				// 		ws.send("down")
				// 		console.log("down")
				// 		break
				// 	case 53:
				// 		ws.send("flyaway")
				// 		break
					
				// }
				switch(event.keyCode)
				{
					case 39://right arrow
					console.log("rotate-right")
					ws.send("rotate-right")
					break;
					case 37://left arrow
					console.log("rotate-left")
					ws.send("rotate-left")
					break;
					case 38://arrow up for forward
					console.log("arrow up forward")
					ws.send("forward")
					break;
					case 40: //arrow down for backward
					console.log("arrow down backward")
					ws.send("backward")
					break;
					case 13://enter
					console.log("enter to takeoff")
					ws.send("takeoff")
					break;
					case 65://A
					console.log("A to left move")
					ws.send("left")
					break;
					case 68://D
					console.log("D to right move")
					ws.send("right")
					break;
					case 9://Tab
					console.log("Tab to go up")
					ws.send("up")
					break;
					case 16://Shift
					console.log("shift to lower level")
					ws.send("down")
					break;
					case 17://left Ctrl
					console.log("land")
					ws.send("land")
				}
			})
		ws.onmessage = (msg)=>{
			// console.log(gamepad.buttons[1].value) trigger
			const content = JSON.parse(msg.data)
			// console.log(content.yaw)
			document.querySelector('.battery-state').innerHTML = content.battery
			document.querySelector('.temp-state').innerHTML = `${content.temperature.low} / ${content.temperature.high}`
			document.querySelector('.h-slider').value = content.heigh
			document.querySelector('.h-value').innerHTML = content.heigh
			document.querySelector('.drone-icon').style.transform = `rotate(${content.yaw}deg)`
			document.querySelector('.drone-speed-x').innerHTML = `X: ${content.speed.x}`
			document.querySelector('.drone-speed-y').innerHTML = `Y: ${content.speed.y}`
			document.querySelector('.drone-speed-z').innerHTML = `Z: ${content.speed.z}`
		}
		ws.onopen = ()=>
		{
			console.log('open')
		}
	</script>
	<div class='drone-stats'>
		<div class='drone-states'>
			<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-battery-full" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
				<path fill-rule="evenodd" d="M12 5H2a1 1 0 0 0-1 1v4a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1zM2 4a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H2z"/>
				<path d="M2 6h10v4H2V6zm12.5 3.5a1.5 1.5 0 0 0 0-3v3z"/>
			  </svg>
			<span class='battery-state'>battery</span>
			</br>
			<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-thermometer" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
				<path fill-rule="evenodd" d="M6 2a2 2 0 1 1 4 0v7.627a3.5 3.5 0 1 1-4 0V2zm2-1a1 1 0 0 0-1 1v7.901a.5.5 0 0 1-.25.433A2.499 2.499 0 0 0 8 15a2.5 2.5 0 0 0 1.25-4.666.5.5 0 0 1-.25-.433V2a1 1 0 0 0-1-1z"/>
				<path d="M9.5 12.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
			  </svg>
			<span class='temp-state'>temp</span>
		</div>
		<div class='drone-height'>
			<input type='range' min="0" max="12000" value='0' class='h-slider' id='h-range' orient='vertical'>
			<p>Height</p>
			<p class='h-value'></p>
		</div>
		<div class='drone-position-state'>
			<img class='drone-icon' src='./drone.png'/ width="100" height="100">
			<span class='drone-speed-box'>
				Speed
			</br>
				<span class='drone-speed-x'>X:0</span>
			</br>
				<span class='drone-speed-y'>Y:0</span>
		</br>
				<span class='drone-speed-z'>Z:0</span>
			</span>
			<!-- Example output of state:
{ 
    pitch: 1,
    roll: 0,
    yaw: 0,
    speed: { x: 0, y: 0, z: 0 },
    temperature: { low: 51, high: 53 },
    tof: 6553,
    heigh: 0,
    battery: 87,
    barometer: 24.65,
    time: 0,
    acceleration: { x: 16, y: 3, z: -990 } 
} -->
		</div>
	</div>
</body>
</html>
