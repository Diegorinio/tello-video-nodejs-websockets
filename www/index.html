<!DOCTYPE html>
<html>
<head>
	<title>Tello Video Stream Example</title>
	<link rel='stylesheet' href='./main.css'>
</head>
<body>
	<canvas height="720" width="568" id="video-canvas"></canvas>
	<div class='path-box'>
		<canvas height="100" width="100" id='path-canvas'></canvas>
	</br>
		<span class='drone-path'>Path to fly</span>
		<button class='fly-to-path-btn'">FLY</button>
	</div>
	<script type="text/javascript" src="jsmpeg.min.js"></script>
	<script type="text/javascript">
		var ws = new WebSocket('ws://localhost:8000/')
		var canvas = document.getElementById('video-canvas');
		var url = 'ws://'+document.location.hostname+':3001/stream';
		console.log(url)
		var player = new JSMpeg.Player(url, {canvas: canvas});
		var gl = canvas.getContext("webgl")
		window.addEventListener('keydown', (event)=>{
				switch(event.keyCode)
				{
					case 39:
						console.log("right")
						ws.send("rotate-right")
						break;
					case 37:
						console.log("left")
						ws.send("rotate-left")
						break
					case 80:
						ws.send("takeoff")
						console.log("takeoff")
						break;
					case 16:
						ws.send("land")
						console.log("land")
						break;
					case 87:
						ws.send("forward")
						console.log("ku przygodzie")
					case 83:
						ws.send("backward")
						console.log("francuz")
						break
					case 65:
						ws.send("left")
						console.log("left")
						break
					case 68:
						ws.send("right")
						console.log("right")
						break
					case 38:
						ws.send("up")
						console.log('up')
						break
					case 40:
						ws.send("down")
						console.log("down")
						break
					case 53:
						ws.send("flyaway")
						console.log('flyaway')
						break
					
				}
			})
		ws.onmessage = (msg)=>{
			const content = JSON.parse(msg.data)
			// console.log(content)
			document.querySelector('.battery-state').innerHTML = content.battery
			document.querySelector('.temp-state').innerHTML = `${content.temperature.low} / ${content.temperature.high}`
			document.querySelector('.h-slider').value = content.heigh
			document.querySelector('.h-value').innerHTML = content.heigh
		}
		ws.onopen = ()=>
		{
			console.log('open')
		}
	</script>
	<script>
		var ws = new WebSocket('ws://localhost:8000/')
		var path_canvas
		var path_canvasContext
		const markerOne = {x:0,y:0}
		function placeMarker(x,y){
			drawMap()
			markerOne.x = x
			markerOne.y = y
			path_canvasContext.fillStyle = 'red'
			path_canvasContext.fillRect(x, y, 1, 1)
		}
		function setDrone()
		{
			path_canvasContext.fillStyle = 'yellow'
			path_canvasContext.fillRect(path_canvas.width/2-10, path_canvas.height/2-10, 10, 10)
		}
		window.onload = function(){
		var fly_btn = document.querySelector('.fly-to-path-btn')
		path_canvas = document.getElementById('path-canvas')
		path_canvasContext = path_canvas.getContext("2d")
		getMousePosition = (e) =>{
    		var rect = path_canvas.getBoundingClientRect()
    		var root = document.documentElement
    		var mouseX = e.clientX - rect.left
    		var mouseY = e.clientY - rect.top
    		return {
        		x:mouseX,
        		y:mouseY
    		}
		}
		const dronepos = {x:path_canvas.width/2-10, y:path_canvas.height/2-10}
		path_canvas.addEventListener('mousedown',(e)=>{
			var mousePos = getMousePosition(e)
			markerOne.x = parseInt(mousePos.x)
			markerOne.y = parseInt(mousePos.y)
			console.log(mousePos)
			console.log(markerOne.x, markerOne.y)
			placeMarker(markerOne.x, markerOne.y)
			document.querySelector('.drone-path').innerHTML = `Path to fly \n x: ${markerOne.x-dronepos.x} y: ${markerOne.y-dronepos.y}`
		})
		fly_btn.addEventListener("click", ()=>{
			console.log(`fly to ${markerOne.x} ${markerOne.y}`)
			ws.send(`FlyTo={"x":${markerOne.y-dronepos.y},"y":${markerOne.x-dronepos.x}}`)
		})
	drawMap()	
}
	function drawMap()
	{
		path_canvasContext.fillStyle = 'black'
		path_canvasContext.fillRect(0,0, path_canvas.width, path_canvas.height)
		//drone postiiton at bottom not lower than 20
		setDrone()
	}
	</script>
	<div class='drone-stats'>
		<div class='drone-states'>
			<span>battery:</span><p class='battery-state'>battery</p>
			<span>temp:</span><p class='temp-state'>temp</p>
		</div>
		<div class='drone-height'>
			<input type='range' min="0" max="1000" value='0' class='h-slider' id='h-range' orient='vertical'>
			<p>Height</p>
			<p class='h-value'></p>
		</div>
	</div>
</body>
</html>
